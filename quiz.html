<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Professional Road Safety Quiz - AI-Powered Assessment</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    /* Merged font family, prioritizing Inter from the new CSS */
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }
    
    /* Merged body styles, using the new gradient */
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
      background: linear-gradient(135deg, #2563EB 0%, #9333EA 50%, #4338CA 100%);
    }

    /* Enable smooth scrolling for the entire page */
    html {
      scroll-behavior: smooth;
    }

    /* Animation for floating effect on decorative elements */
    @keyframes float {
      0%, 100% {
        transform: translateY(0px) rotate(0deg);
      }
      25% {
        transform: translateY(-8px) rotate(1deg);
      }
      50% {
        transform: translateY(-15px) rotate(0deg);
      }
      75% {
        transform: translateY(-8px) rotate(-1deg);
      }
    }

    /* Animation for gradient background shift */
    @keyframes gradient-shift {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    /* Animation for sliding in elements from the left */
    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Animation for sliding in elements from the right */
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Animation for fading in elements with upward movement */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Animation for zoom-in effect */
    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Animation for bounce-in effect */
    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3);
      }
      50% {
        opacity: 1;
        transform: scale(1.1);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Apply float animation to elements */
    .animate-float {
      animation: float 6s ease-in-out infinite;
    }

    /* Apply gradient animation to elements */
    .animate-gradient {
      background-size: 200% 200%;
      animation: gradient-shift 4s ease infinite;
    }

    /* Apply slide-in animation */
    .animate-slide-in {
      animation: slideInLeft 0.6s ease-out;
    }

    /* Apply fade-up animation */
    .animate-fade-up {
      animation: fadeInUp 0.8s ease-out;
    }

    /* Floating animations */
    .floating {
      animation: float 4s ease-in-out infinite;
    }

    .floating-delayed {
      animation: float 4s ease-in-out infinite;
      animation-delay: 1s;
    }

    .floating-slow {
      animation: float 6s ease-in-out infinite;
      animation-delay: 0.5s;
    }

    /* Gradient background variations */
    .blue-purple-bg-alt {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      background-size: 400% 400%;
      animation: gradientShiftAlt 10s ease infinite;
    }

    @keyframes gradientShiftAlt {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .blue-purple-bg-success {
      background: linear-gradient(to right, #2563EB, #9333EA);
    }

    .blue-purple-bg-warning {
      background: linear-gradient(to right, #9333EA, #2563EB);
    }

    /* Glassmorphism effects */
    .glass, .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
    }

    .glass-dark {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Option button styles */
    .option-btn {
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
      transform-origin: center;
    }

    .option-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
      transition: left 0.6s ease-out;
    }

    .option-btn:hover::before {
      left: 100%;
    }

    .option-btn:hover:not(:disabled) {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
    }

    .option-btn:active:not(:disabled) {
      transform: translateY(-2px) scale(0.98);
    }

    /* Progress bar styles */
    .progress-bar {
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #6366f1);
      background-size: 200% 100%;
      animation: gradientShift 3s ease-in-out infinite;
      transition: width 0.5s ease-in-out;
    }

    /* Card hover effects */
    .card-hover, .info-card {
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .card-hover:hover, .info-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
    }

    /* AI insight styles */
    .ai-insight {
      background: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7, #c084fc, #e879f9);
      background-size: 400% 400%;
      animation: aiGradientShift 8s ease-in-out infinite;
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border: 3px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 30px 80px rgba(147, 51, 234, 0.4);
      position: relative;
      overflow: hidden;
    }

    .ai-insight::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent, rgba(255,255,255,0.1), transparent);
      animation: aiShimmer 6s ease-in-out infinite;
    }

    .ai-insight::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
      border-radius: inherit;
      opacity: 0.7;
    }

    @keyframes aiGradientShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 100% 0%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes aiShimmer {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      50% { transform: translateX(50%) translateY(50%) rotate(45deg); }
      100% { transform: translateX(200%) translateY(200%) rotate(45deg); }
    }

    /* Metric card styles */
    .metric-card {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }

    /* Pass and fail badge styles */
    .pass-badge, .pass-badge-enhanced {
      background: linear-gradient(135deg, #059669, #10b981, #34d399, #6ee7b7, #a7f3d0);
      background-size: 300% 300%;
      animation: pulseGlowGreen 2s ease-in-out infinite, gradientShiftGreen 4s ease-in-out infinite;
      color: white;
      padding: 24px 48px;
      border-radius: 50px;
      font-size: 2.5rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 3px;
      border: 3px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 20px 50px rgba(16, 185, 129, 0.4);
    }

    .fail-badge, .fail-badge-enhanced {
      background: linear-gradient(135deg, #dc2626, #ef4444, #f87171, #fca5a5, #fde0e0);
      background-size: 300% 300%;
      animation: pulseGlowRed 2s ease-in-out infinite, gradientShiftRed 4s ease-in-out infinite;
      color: white;
      padding: 24px 48px;
      border-radius: 50px;
      font-size: 2.5rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 3px;
      border: 3px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 20px 50px rgba(239, 68, 68, 0.4);
    }

    @keyframes pulseGlowGreen {
      0%, 100% {
        box-shadow: 0 15px 40px rgba(34, 197, 94, 0.5);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 25px 60px rgba(34, 197, 94, 0.8);
        transform: scale(1.05);
      }
    }

    @keyframes pulseGlowRed {
      0%, 100% {
        box-shadow: 0 15px 40px rgba(239, 68, 68, 0.5);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 25px 60px rgba(239, 68, 68, 0.8);
        transform: scale(1.05);
      }
    }

    @keyframes gradientShiftGreen {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes gradientShiftRed {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Input field styles */
    .input-field {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 16px 20px;
      font-size: 16px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .input-field:focus {
      outline: none;
      border-color: #2563EB;
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.2);
    }

    /* Error message styles */
    .error-message {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 8px;
      font-size: 14px;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
      20%, 40%, 60%, 80% { transform: translateX(4px); }
    }

    /* Ripple button styles */
    .ripple-btn {
      position: relative;
      overflow: hidden;
    }

    .ripple-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .ripple-btn:active::after {
      width: 300px;
      height: 300px;
    }

    /* Particle animation styles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: particleFloat 8s linear infinite;
    }

    @keyframes particleFloat {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }

    /* Spinner styles */
    .enhanced-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(59, 130, 246, 0.1);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite, pulseGlow 2s ease-in-out infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
      50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.6); }
    }

    /* Typing effect styles */
    .typing-effect {
      overflow: hidden;
      border-right: 2px solid #3b82f6;
      white-space: nowrap;
      animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
    }

    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }

    @keyframes blink-caret {
      from, to { border-color: transparent; }
      50% { border-color: #3b82f6; }
    }

    /* Staggered animation delays */
    .stagger-1 { animation-delay: 0.1s; }
    .stagger-2 { animation-delay: 0.2s; }
    .stagger-3 { animation-delay: 0.3s; }
    .stagger-4 { animation-delay: 0.4s; }

    /* Result card styles */
    .result-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1));
      backdrop-filter: blur(30px);
      border: 2px solid rgba(255,255,255,0.4);
      transition: all 0.5s ease;
      position: relative;
      overflow: hidden;
    }

    .result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.8s ease;
    }

    .result-card:hover::before {
      left: 100%;
    }

    .result-card:hover {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    }

    /* AI header styles */
    .ai-header {
      background: linear-gradient(135deg, #0ea5e9, #06b6d4, #14b8a6, #10b981);
      background-size: 300% 300%;
      animation: aiHeaderGlow 4s ease-in-out infinite;
      border: 2px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 0 30px rgba(6, 182, 212, 0.6), 0 0 60px rgba(6, 182, 212, 0.4), inset 0 2px 20px rgba(255, 255, 255, 0.3);
    }

    @keyframes aiHeaderGlow {
      0%, 100% {
        background-position: 0% 50%;
        box-shadow: 0 0 30px rgba(6, 182, 212, 0.6), 0 0 60px rgba(6, 182, 212, 0.4), inset 0 2px 20px rgba(255, 255, 255, 0.3);
      }
      50% {
        background-position: 100% 50%;
        box-shadow: 0 0 40px rgba(16, 185, 129, 0.8), 0 0 80px rgba(16, 185, 129, 0.5), inset 0 2px 25px rgba(255, 255, 255, 0.4);
      }
    }

    /* Strength indicator styles */
    .strength-indicator {
      height: 16px;
      border-radius: 8px;
      background: linear-gradient(90deg, #1f2937, #374151);
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.3), 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .strength-indicator .strength-fill {
      height: 100%;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      transition: width 1s ease-out;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
      animation: strengthGlow 3s ease-in-out infinite;
    }

    .strength-indicator .strength-fill.high {
      background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7, #a7f3d0);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.7), 0 0 40px rgba(52, 211, 153, 0.4);
    }

    .strength-indicator .strength-fill.medium {
      background: linear-gradient(90deg, #f59e0b, #fbbf24, #fcd34d, #fde68a);
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.7), 0 0 40px rgba(251, 191, 36, 0.4);
    }

    .strength-indicator .strength-fill.low {
      background: linear-gradient(90deg, #ef4444, #f87171, #fca5a5, #fecaca);
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.7), 0 0 40px rgba(248, 113, 113, 0.4);
    }

    @keyframes strengthGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2); }
    }

    /* Score card styles */
    .score-card-1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      border: 2px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 25px 50px rgba(102, 126, 234, 0.3);
    }

    .score-card-2 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      position: relative;
      border: 2px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 25px 50px rgba(240, 147, 251, 0.3);
    }

    .score-card-3 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      position: relative;
      border: 2px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 25px 50px rgba(79, 172, 254, 0.3);
    }

    .score-card-1::before,
    .score-card-2::before,
    .score-card-3::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.2), transparent, rgba(255,255,255,0.2));
      border-radius: inherit;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .score-card-1:hover::before,
    .score-card-2:hover::before,
    .score-card-3:hover::before {
      opacity: 1;
    }

    /* Result icon styles */
    .result-icon-enhanced {
      border: 4px solid transparent;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(45deg, #ff0080, #ff8c00, #40e0d0, #ff0080) border-box;
      animation: rotateBorder 3s linear infinite;
    }

    @keyframes rotateBorder {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Category card styles */
    .category-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.15));
      backdrop-filter: blur(30px);
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 20px;
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(255,255,255,0.1);
    }

    .category-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }

    .category-card:hover::before {
      left: 100%;
    }

    .category-card:hover {
      transform: translateY(-5px) scale(1.03);
      border-color: rgba(255,255,255,0.7);
      box-shadow: 0 25px 50px rgba(255,255,255,0.2);
    }

    /* AI summary card styles */
    .ai-summary-card {
      background: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
      background-size: 400% 400%;
      animation: rainbowShift 6s ease-in-out infinite;
      border: 3px solid rgba(255, 255, 255, 0.6);
      position: relative;
      overflow: hidden;
      box-shadow: 0 25px 60px rgba(255, 107, 107, 0.3);
    }

    @keyframes rainbowShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 50% 0%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 50% 100%; }
      100% { background-position: 0% 50%; }
    }

    /* Button styles */
    .home-btn-enhanced {
      background: linear-gradient(135deg, #667eea, #764ba2, #f093fb, #f5576c);
      background-size: 300% 300%;
      animation: gradientShiftMulti 4s ease-in-out infinite;
      box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.5);
    }

    .retake-btn-enhanced {
      background: linear-gradient(135deg, #667eea, #764ba2, #f78ca0, #f9748f);
      background-size: 300% 300%;
      animation: gradientShiftMulti2 4s ease-in-out infinite;
      box-shadow: 0 20px 40px rgba(139, 92, 246, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.5);
    }

    .share-btn-enhanced {
      background: linear-gradient(135deg, #4facfe, #00f2fe, #43e97b, #38f9d7);
      background-size: 300% 300%;
      animation: gradientShiftMulti3 4s ease-in-out infinite;
      box-shadow: 0 20px 40px rgba(6, 182, 212, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.5);
    }

    @keyframes gradientShiftMulti {
      0%, 100% { background-position: 0% 50%; }
      25% { background-position: 100% 0%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
    }

    @keyframes gradientShiftMulti2 {
      0%, 100% { background-position: 0% 50%; }
      33% { background-position: 100% 0%; }
      66% { background-position: 50% 100%; }
    }

    @keyframes gradientShiftMulti3 {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Action button styles */
    .action-btn {
      background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
      background-size: 300% 300%;
      animation: gradientShiftMulti 4s ease-in-out infinite;
      box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
    }

    .action-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 25px 50px rgba(102, 126, 234, 0.6);
    }

    /* Category icon styles */
    .category-icon-mandatory {
      background: linear-gradient(135deg, #ef4444, #f87171, #fca5a5);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }

    .category-icon-cautionary {
      background: linear-gradient(135deg, #f59e0b, #fbbf24, #fcd34d);
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
    }

    .category-icon-informational {
      background: linear-gradient(135deg, #3b82f6, #60a5fa, #93c5fd);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }

    .category-icon-rules {
      background: linear-gradient(135deg, #8b5cf6, #a78bfa, #c4b5fd);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
    }

    /* Timer warning styles */
    .timer-warning {
      animation: timerPulse 0.5s ease-in-out infinite alternate;
    }

    @keyframes timerPulse {
      from { transform: scale(1); }
      to { transform: scale(1.1); }
    }

    /* Chatbot styles */
    .chatbot-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .chatbot-toggle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
      background-size: 300% 300%;
      animation: gradientShiftMulti 4s ease-in-out infinite;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .chatbot-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
    }

    .chatbot-window {
      position: absolute;
      bottom: 80px;
      right: 0;
      width: 380px;
      height: 600px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      transform: scale(0) translateY(50px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chatbot-window.open {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    .chatbot-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      text-align: center;
      border-radius: 18px 18px 0 0;
    }

    .chatbot-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .message {
      max-width: 85%;
      padding: 14px 18px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
      animation: fadeInUp 0.3s ease-out;
      word-wrap: break-word;
    }

    .message.bot {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 1px solid rgba(59, 130, 246, 0.2);
      align-self: flex-start;
      color: #1e40af;
    }

    .message.user {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      align-self: flex-end;
    }

    .message.typing {
      background: #f3f4f6;
      color: #6b7280;
      align-self: flex-start;
    }

    .chatbot-input-container {
      padding: 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0 0 18px 18px;
      position: relative;
    }

    .chatbot-input {
      width: 100%;
      padding: 12px 50px 12px 16px;
      border: 2px solid rgba(59, 130, 246, 0.2);
      border-radius: 25px;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
      background: white;
    }

    .chatbot-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .chatbot-send {
      position: absolute;
      right: 25px;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      cursor: pointer;
      color: white;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chatbot-send:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .chatbot-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .option-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .option-button {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 10px 15px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 13px;
      text-align: left;
      color: #1e40af;
    }

    .option-button:hover {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      transform: translateY(-1px);
    }

    .loading-dots {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .loading-dots span {
      width: 6px;
      height: 6px;
      background: #6b7280;
      border-radius: 50%;
      animation: loadingDots 1.4s infinite ease-in-out both;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes loadingDots {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Category breakdown card styles */
    .category-breakdown-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
      backdrop-filter: blur(25px);
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 16px;
      box-shadow: 0 15px 35px rgba(255, 255, 255, 0.15);
      transition: all 0.3s ease;
    }

    .category-breakdown-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 40px rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.7);
    }

    /* Time analysis card styles */
    .time-analysis-card {
      background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
      background-size: 300% 300%;
      animation: timeCardShift 5s ease-in-out infinite;
      border: 3px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 25px 50px rgba(102, 126, 234, 0.3);
    }

    @keyframes timeCardShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Recommendations card styles */
    .recommendations-card {
      background: linear-gradient(135deg, #ffecd2, #fcb69f, #ff9a9e, #fecfef, #fecfef);
      background-size: 400% 400%;
      animation: recommendationShift 7s ease-in-out infinite;
      border: 3px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 25px 50px rgba(255, 154, 158, 0.3);
      color: #1f2937;
    }

    @keyframes recommendationShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 50% 0%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 50% 100%; }
      100% { background-position: 0% 50%; }
    }

    /* Mobile menu hidden by default */
    .mobile-menu {
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
    }

    /* Mobile menu visible when active */
    .mobile-menu.active {
      transform: translateX(0);
    }

    /* Custom scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
    }

    /* Dark mode color scheme */
    .dark {
      color-scheme: dark;
    }

    /* Dark mode scrollbar styling */
    .dark ::-webkit-scrollbar-track {
      background: #1f2937;
    }

    .dark ::-webkit-scrollbar-thumb {
      background: #374151;
    }

    .dark ::-webkit-scrollbar-thumb:hover {
      background: #4b5563;
    }

    /* Styling for learning path text with gradient effect */
    .learning-path {
      background: linear-gradient(45deg, #60a5fa, #a78bfa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Media queries */
    @media (max-width: 768px) {
      .floating, .floating-delayed, .floating-slow {
        animation-duration: 5s;
      }

      .particle {
        display: none;
      }

      .chatbot-window {
        width: calc(100vw - 30px);
        height: 70vh;
        right: -15px;
      }

      .chatbot-toggle {
        width: 55px;
        height: 55px;
      }
    }

    @media (prefers-contrast: high) {
      .glass-effect {
        background: rgba(255, 255, 255, 0.98);
        border: 2px solid rgba(0, 0, 0, 0.2);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .floating, .floating-delayed, .floating-slow,
      .pulseGlow, .pulseGlowGreen, .pulseGlowRed,
      .fade-in, .fade-in-delayed, .fade-in-slow,
      .slide-in-left, .slide-in-right, .timer-warning,
      .enhanced-spinner, .typing-effect, .particle,
      .progress-bar, .aiShimmer, .strengthGlow,
      .gradientShiftGreen, .gradientShiftRed,
      .gradientShiftMulti, .gradientShiftMulti2, .gradientShiftMulti3,
      .rotateBorder, .aiGradientShift, .aiHeaderGlow,
      .timeCardShift, .recommendationShift, .rainbowShift,
      .gradientShiftAlt, .gradientShift, .zoom-in, .bounce-in,
      .animate-float, .animate-gradient, .animate-slide-in, .animate-fade-up {
        animation: none !important;
      }

      .option-btn::before, .ai-insight::before, .result-card::before, .category-card::before {
        display: none;
      }

      * {
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-800 relative">
    <!-- Animated particles background -->
    <div class="particles" id="particles-container"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden min-h-screen flex items-center justify-center">
        <div class="glass-effect rounded-3xl p-12 text-center animate__animated animate__zoomIn">
            <div class="enhanced-spinner mx-auto mb-6"></div>
            <p class="text-gray-700 font-medium text-lg mb-4">Preparing your personalized quiz...</p>
            <div class="text-sm text-gray-500">
                <span class="typing-effect">Analyzing road safety categories</span>
            </div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-5xl w-full space-y-8">
            <!-- Hero Section -->
            <div class="text-center space-y-6 animate__animated animate__fadeInDown">
                <div class="inline-block">
                    <div class="relative">
                        <div class="w-24 h-24 bg-white/20 rounded-3xl mx-auto flex items-center justify-center backdrop-blur-sm border border-white/30 floating shadow-2xl">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l2.414 2.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0M15 17a2 2 0 104 0"></path>
                            </svg>
                        </div>
                        <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full floating-delayed opacity-80"></div>
                        <div class="absolute -bottom-2 -left-2 w-4 h-4 bg-green-400 rounded-full floating-slow opacity-80"></div>
                    </div>
                </div>
                <div class="space-y-4">
                    <h1 class="text-5xl md:text-7xl font-bold text-white leading-tight animate__animated animate__fadeInUp">Road Safety Quiz</h1>
                    <div class="text-xl md:text-2xl text-white/90 max-w-3xl mx-auto animate__animated animate__fadeInUp animate__delay-1s">
                        <span class="bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent font-semibold">AI-Powered Assessment</span>
                        <br>
                        Test your knowledge of road safety rules and traffic signs to become a safer driver.
                    </div>
                </div>
            </div>

            <!-- User Registration -->
            <div class="glass-effect rounded-3xl p-8 shadow-2xl border border-white/20 animate__animated animate__fadeInLeft animate__delay-1s">
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 flex items-center justify-center">
                            <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6-4a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Registration Required
                        </h2>
                        <p class="text-gray-600">Please provide your details to start the AI-powered assessment</p>
                    </div>
                    <div class="space-y-6">
                        <div class="slide-in-left">
                            <label for="user-name" class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Full Name
                            </label>
                            <input
                                type="text"
                                id="user-name"
                                class="input-field w-full bg-white/90 border-2 border-gray-200 rounded-xl px-6 py-4 text-gray-800 placeholder-gray-400 focus:outline-none focus:border-blue-500 focus:bg-white focus:ring-4 focus:ring-blue-500/20 transition-all duration-300 text-lg"
                                placeholder="Enter your full name"
                                required
                            />
                            <div id="name-error" class="error-message hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mt-3 text-sm animate__animated animate__shakeX">
                                Please enter your full name
                            </div>
                        </div>
                        <div class="slide-in-right">
                            <label for="user-dob" class="block text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Date of Birth
                            </label>
                            <input
                                type="date"
                                id="user-dob"
                                class="input-field w-full bg-white/90 border-2 border-gray-200 rounded-xl px-6 py-4 text-gray-800 focus:outline-none focus:border-purple-500 focus:bg-white focus:ring-4 focus:ring-purple-500/20 transition-all duration-300 text-lg"
                                required
                            />
                            <div id="dob-error" class="error-message hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mt-3 text-sm animate__animated animate__shakeX">
                                You must be at least 18 years old to take this quiz
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Information -->
            <div class="glass-effect rounded-3xl p-8 shadow-2xl border border-white/20 animate__animated animate__fadeInRight animate__delay-1s">
                <div class="max-w-4xl mx-auto space-y-8">
                    <div class="text-center mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Assessment Categories</h3>
                        <p class="text-gray-600">Your knowledge will be tested across these key areas</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                        <div class="info-card space-y-3 p-6 bg-gradient-to-br from-blue-500/10 to-blue-600/10 rounded-2xl border border-blue-200/30 stagger-1 animate__animated animate__fadeInUp">
                            <div class="w-16 h-16 category-icon-mandatory rounded-2xl mx-auto flex items-center justify-center shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <h4 class="font-bold text-gray-800 text-lg">Mandatory Signs</h4>
                            <p class="text-sm text-gray-600">Stop, yield, and regulatory signs</p>
                        </div>
                        
                        <div class="info-card space-y-3 p-6 bg-gradient-to-br from-yellow-500/10 to-orange-600/10 rounded-2xl border border-yellow-200/30 stagger-2 animate__animated animate__fadeInUp">
                            <div class="w-16 h-16 category-icon-cautionary rounded-2xl mx-auto flex items-center justify-center shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h4 class="font-bold text-gray-800 text-lg">Cautionary Signs</h4>
                            <p class="text-sm text-gray-600">Warning and hazard indicators</p>
                        </div>
                        
                        <div class="info-card space-y-3 p-6 bg-gradient-to-br from-green-500/10 to-emerald-600/10 rounded-2xl border border-green-200/30 stagger-3 animate__animated animate__fadeInUp">
                            <div class="w-16 h-16 category-icon-informational rounded-2xl mx-auto flex items-center justify-center shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h4 class="font-bold text-gray-800 text-lg">Informational Signs</h4>
                            <p class="text-sm text-gray-600">Guidance and direction signs</p>
                        </div>
                        
                        <div class="info-card space-y-3 p-6 bg-gradient-to-br from-purple-500/10 to-indigo-600/10 rounded-2xl border border-purple-200/30 stagger-4 animate__animated animate__fadeInUp">
                            <div class="w-16 h-16 category-icon-rules rounded-2xl mx-auto flex items-center justify-center shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h4 class="font-bold text-gray-800 text-lg">Traffic Rules</h4>
                            <p class="text-sm text-gray-600">Laws and regulations</p>
                        </div>
                    </div>

                    <!-- Quiz Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div class="info-card space-y-3 p-6 bg-gradient-to-br from-blue-500/20 to-blue-600/20 rounded-2xl border border-blue-200/40 animate__animated animate__bounceIn animate__delay-2s">
                            <div class="w-14 h-14 bg-blue-100 rounded-2xl mx-auto flex items-center justify-center">
                                <span class="text-3xl font-bold text-blue-600">20</span>
                            </div>
                            <h3 class="font-semibold text-gray-800 text-lg">Questions</h3>
                            <p class="text-sm text-gray-600">Comprehensive assessment</p>
                        </div>
                        <div class="info-card space-y-3 p-6 bg-gradient-to-br from-purple-500/20 to-purple-600/20 rounded-2xl border border-purple-200/40 animate__animated animate__bounceIn animate__delay-2s">
                            <div class="w-14 h-14 bg-purple-100 rounded-2xl mx-auto flex items-center justify-center">
                                <span class="text-3xl font-bold text-purple-600">30s</span>
                            </div>
                            <h3 class="font-semibold text-gray-800 text-lg">Per Question</h3>
                            <p class="text-sm text-gray-600">Think carefully</p>
                        </div>
                        <div class="info-card space-y-3 p-6 bg-gradient-to-br from-green-500/20 to-green-600/20 rounded-2xl border border-green-200/40 animate__animated animate__bounceIn animate__delay-2s">
                            <div class="w-14 h-14 bg-green-100 rounded-2xl mx-auto flex items-center justify-center">
                                <span class="text-3xl font-bold text-green-600">75%</span>
                            </div>
                            <h3 class="font-semibold text-gray-800 text-lg">Pass Rate</h3>
                            <p class="text-sm text-gray-600">15 correct required</p>
                        </div>
                    </div>
                    
                    <div class="text-center pt-8">
                        <button
                            id="start-quiz-btn"
                            class="ripple-btn bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 hover:from-blue-700 hover:via-purple-700 hover:to-indigo-700 text-white font-bold py-5 px-16 rounded-full transition-all duration-500 transform hover:scale-110 shadow-2xl hover:shadow-3xl flex items-center mx-auto space-x-4 text-lg animate__animated animate__pulse animate__infinite"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <span>Start AI Assessment</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-screen" class="hidden min-h-screen p-4">
        <div class="max-w-5xl mx-auto space-y-6">
            <!-- Progress Header -->
            <div class="glass-effect rounded-3xl shadow-2xl p-6 border border-white/20 animate__animated animate__slideInDown">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <div class="flex items-center space-x-8">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                            </div>
                            <span class="font-medium text-gray-800 text-lg">
                                Question <span id="current-question" class="font-bold text-blue-600">1</span> / <span id="total-questions" class="font-bold">20</span>
                            </span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                </svg>
                            </div>
                            <span class="font-medium text-gray-800 text-lg">
                                Score: <span id="current-score" class="font-bold text-green-600">0</span>
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6">
                        <div class="text-sm text-gray-600 flex items-center bg-white/50 px-4 py-2 rounded-full">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span id="quiz-user-name" class="font-medium">User</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
                                <svg id="timer-icon" class="w-5 h-5 text-orange-600 timer-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <span id="timer-text" class="font-medium text-gray-800 text-lg">
                                <span id="time-left" class="font-bold text-red-500">30</span>s
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Progress Bar -->
                <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div 
                        id="progress-bar"
                        class="progress-bar h-4 rounded-full transition-all duration-700 ease-out"
                        style="width: 5%"
                    ></div>
                </div>
            </div>

            <!-- Question Image -->
            <div id="question-image-container" class="hidden glass-effect rounded-3xl p-6 shadow-lg border border-white/20 animate__animated animate__zoomIn">
                <img 
                    id="question-image"
                    class="w-full max-h-80 object-contain rounded-2xl shadow-lg" 
                    alt="Question visual"
                />
            </div>

            <!-- Question Text -->
            <div class="glass-effect rounded-3xl shadow-2xl p-8 border border-white/20 animate__animated animate__fadeInUp">
                <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center flex-shrink-0 mt-1 shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div id="question-text" class="text-xl font-medium text-gray-800 leading-relaxed" role="region" aria-live="polite">
                        Loading question...
                    </div>
                </div>
            </div>

            <!-- Options -->
            <div id="options-container" class="grid gap-4"></div>
        </div>
    </div>

    <!-- Results Screen with Enhanced Bright AI Analysis -->
    <div id="results-screen" class="hidden min-h-screen p-4 flex items-center justify-center">
        <div class="max-w-6xl w-full">
            <div class="glass-effect rounded-3xl shadow-2xl p-8 border-2 border-white/30 animate__animated animate__zoomIn">
                <!-- Results Header with Enhanced Icon -->
                <div class="text-center space-y-6 mb-10">
                    <div id="result-icon" class="w-28 h-28 bg-gradient-to-r from-emerald-400 via-teal-500 to-cyan-600 rounded-full mx-auto flex items-center justify-center animate__animated animate__bounceIn animate__delay-1s result-icon-enhanced shadow-2xl">
                        <svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                        </svg>
                    </div>
                    <h2 class="text-5xl font-bold bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent animate__animated animate__fadeInUp animate__delay-1s">Assessment Complete!</h2>
                    <p class="text-gray-700 text-xl animate__animated animate__fadeInUp animate__delay-1s font-medium">AI-powered analysis of your road safety knowledge</p>
                    <div class="text-xl font-medium text-gray-800 flex items-center justify-center animate__animated animate__fadeInUp animate__delay-1s">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-3 rounded-2xl shadow-lg mr-3">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <span id="results-user-name" class="bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent font-bold">User</span>
                    </div>
                </div>

                <!-- Enhanced Pass/Fail Badge -->
                <div class="text-center mb-10">
                    <div id="pass-fail-badge" class="inline-block px-12 py-6 rounded-full text-white font-bold text-4xl uppercase tracking-widest shadow-2xl pass-badge-enhanced animate__animated animate__tada animate__delay-2s">
                        <span class="flex items-center">
                            <svg class="w-10 h-10 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <span id="pass-fail-text">PASS</span>
                        </span>
                    </div>
                    <p id="pass-fail-message" class="text-xl text-gray-700 mt-6 max-w-3xl mx-auto animate__animated animate__fadeInUp animate__delay-2s font-medium leading-relaxed">
                        Congratulations! You have successfully passed the Road Safety Quiz. You demonstrate good understanding of road safety principles.
                    </p>
                </div>

                <!-- Enhanced Score Display with Vibrant Colors -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                    <div class="result-card score-card-1 text-white rounded-3xl p-10 text-center animate__animated animate__flipInY animate__delay-1s shadow-2xl">
                        <div class="relative z-10">
                            <div class="text-5xl font-bold mb-4 drop-shadow-lg">
                                <span id="final-score">0</span> / <span id="final-total">20</span>
                            </div>
                            <p class="opacity-90 text-xl font-medium">Questions Correct</p>
                            <div class="mt-4 w-16 h-1 bg-white/30 rounded-full mx-auto"></div>
                        </div>
                    </div>
                    <div class="result-card score-card-2 text-white rounded-3xl p-10 text-center animate__animated animate__flipInY animate__delay-1s shadow-2xl">
                        <div class="relative z-10">
                            <div id="final-percentage" class="text-5xl font-bold mb-4 drop-shadow-lg">0%</div>
                            <p class="opacity-90 text-xl font-medium">Accuracy Rate</p>
                            <div class="mt-4 w-16 h-1 bg-white/30 rounded-full mx-auto"></div>
                        </div>
                    </div>
                    <div class="result-card score-card-3 text-white rounded-3xl p-10 text-center animate__animated animate__flipInY animate__delay-1s shadow-2xl">
                        <div class="relative z-10">
                            <div id="final-time" class="text-5xl font-bold mb-4 drop-shadow-lg">0:00</div>
                            <p class="opacity-90 text-xl font-medium">Time Taken</p>
                            <div class="mt-4 w-16 h-1 bg-white/30 rounded-full mx-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced AI-Powered Analysis Section with Bright Professional Colors -->
                <div class="ai-analysis text-white rounded-3xl p-10 mb-10 animate__animated animate__fadeInUp animate__delay-2s shadow-2xl">
                    <div class="relative z-10">
                        <!-- Bright AI Header with Neon Effect -->
                        <div class="ai-header rounded-3xl p-8 mb-10 shadow-2xl">
                            <div class="flex items-center justify-center space-x-6">
                                <div class="w-24 h-24 bg-white/30 rounded-3xl flex items-center justify-center backdrop-blur-sm border-2 border-white/50 shadow-xl floating">
                                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <div class="text-center">
                                    <h3 class="text-4xl font-bold drop-shadow-lg mb-2"> AI-Powered Analysis</h3>
                                    <p class="text-white/95 text-xl font-medium">Advanced intelligence insights into your performance</p>
                                </div>
                            </div>
                        </div>

                        <!-- Bright AI Analysis Summary -->
                        <div class="ai-summary-card rounded-3xl p-8 mb-8 shadow-2xl">
                            <div class="relative z-10">
                                <h4 class="font-bold text-gray-800 mb-6 text-2xl flex items-center justify-center">
                                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 rounded-2xl mr-4 shadow-xl">
                                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    Smart Analysis Summary
                                </h4>
                                <div id="ai-weakness-summary" class="text-gray-800 text-xl leading-relaxed font-medium text-center">
                                    Analyzing your performance patterns...
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Category Performance and Time Analysis Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <!-- Bright Category Breakdown -->
                            <div class="category-breakdown-card p-8">
                                <h4 class="font-bold text-gray-800 mb-6 text-xl flex items-center">
                                    <div class="bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 p-3 rounded-xl mr-4 shadow-lg">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                    Category Performance
                                </h4>
                                <div id="category-breakdown" class="space-y-6 text-gray-800">
                                    <!-- Category breakdown will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Enhanced Time Analysis Card -->
                            <div class="time-analysis-card p-8 rounded-3xl shadow-2xl">
                                <div class="relative z-10">
                                    <h4 class="font-bold text-white mb-6 text-xl flex items-center">
                                        <div class="bg-white/30 p-3 rounded-xl mr-4 shadow-lg backdrop-blur-sm border border-white/40">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        Time Performance
                                    </h4>
                                    <div class="space-y-5 text-white">
                                        <div class="flex justify-between items-center text-lg bg-white/20 rounded-xl p-4 backdrop-blur-sm">
                                            <span class="font-medium">Total Time:</span>
                                            <span id="analysis-total-time" class="font-bold text-xl">0:00</span>
                                        </div>
                                        <div class="flex justify-between items-center text-lg bg-white/20 rounded-xl p-4 backdrop-blur-sm">
                                            <span class="font-medium">Avg. per Question:</span>
                                            <span id="analysis-avg-time" class="font-bold text-xl">0s</span>
                                        </div>
                                        <div class="flex justify-between items-center text-lg bg-white/20 rounded-xl p-4 backdrop-blur-sm">
                                            <span class="font-medium">Time Efficiency:</span>
                                            <span id="analysis-efficiency" class="font-bold text-xl bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent">Good</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Detailed AI Recommendations with Bright Colors -->
                        <div class="recommendations-card rounded-3xl p-8 shadow-2xl">
                            <div class="relative z-10">
                                <h4 class="font-bold text-gray-800 mb-6 text-2xl flex items-center justify-center">
                                    <div class="bg-gradient-to-r from-violet-600 to-purple-700 p-4 rounded-2xl mr-4 shadow-xl">
                                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                        </svg>
                                    </div>
                                     Personalized AI Recommendations
                                </h4>
                                <div class="bg-white/20 rounded-2xl p-6 backdrop-blur-sm border border-white/30">
                                    <div id="recommendation-text" class="text-gray-800 leading-relaxed text-lg font-medium">
                                        Based on your performance, continue practicing road safety rules and traffic signs to improve your knowledge.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Action Buttons with Bright Vibrant Colors -->
                <div class="flex flex-wrap gap-8 justify-center animate__animated animate__fadeInUp animate__delay-3s">
                    <button
                        id="home-btn"
                        class="ripple-btn home-btn-enhanced text-white px-12 py-5 rounded-3xl font-bold transition-all duration-500 transform hover:scale-110 flex items-center space-x-4 shadow-2xl text-xl"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span>Return to Home</span>
                    </button>
                    <button
                        id="retake-btn"
                        class="ripple-btn retake-btn-enhanced text-white px-12 py-5 rounded-3xl font-bold transition-all duration-500 transform hover:scale-110 flex items-center space-x-4 shadow-2xl text-xl"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Retake Assessment</span>
                    </button>
                    <button
                        id="share-btn"
                        class="ripple-btn share-btn-enhanced text-white px-12 py-5 rounded-3xl font-bold transition-all duration-500 transform hover:scale-110 flex items-center space-x-4 shadow-2xl text-xl"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                        </svg>
                        <span>Share Results</span>
                    </button>
                </div>

                <!-- Enhanced Achievement Celebration -->
                <div class="text-center mt-10 animate__animated animate__fadeInUp animate__delay-4s">
                    <div class="inline-flex items-center space-x-3 bg-gradient-to-r from-amber-400 via-orange-500 to-red-500 text-white px-8 py-4 rounded-2xl font-bold text-lg shadow-xl">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        <span> Assessment Complete - Well Done!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Study Assistant Chatbot -->
    <div class="chatbot-container">
        <button class="chatbot-toggle" id="chatbot-toggle" title="Open AI Study Assistant">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
        </button>

        <div class="chatbot-window" id="chatbot-window">
            <div class="chatbot-header">
                <h3 class="text-lg font-bold flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                     AI Study Assistant
                </h3>
                <p class="text-sm opacity-90 mt-1">Your Road Safety Quiz Coach</p>
            </div>

            <div class="chatbot-messages" id="chatbot-messages">
                <div class="message bot">
                     Hi! I'm your AI Study Assistant. Complete the quiz first to unlock all my features! I can help you understand your performance, explain wrong answers, and provide practice questions.
                </div>
            </div>

            <div class="chatbot-input-container">
                <input 
                    type="text" 
                    class="chatbot-input" 
                    id="chatbot-input" 
                    placeholder="Complete the quiz first to unlock AI features..."
                    disabled
                />
                <button class="chatbot-send" id="chatbot-send" disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</body>

<script>
/* ====== SUPABASE CONFIG ====== */
const SUPABASE_URL = "https://ittpqmsjywssnffqoonv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0dHBxbXNqeXdzc25mZnFvb252Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwNzY3NjksImV4cCI6MjA2NTY1Mjc2OX0.UdnbCkWY2j3JcPSZhEuLJz0-eXX1HQ_daZmTI62zRFU";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== STATE ====== */
let questions = [];
let currentQuestionIndex = 0;
let score = 0;
let timer = null;
let quizStartTime = null;
let userPerformanceData = [];
let userData = { name: '', dateOfBirth: '' };
let quizResults = null;

/* ====== CHATBOT STATE ====== */
let chatbotState = {
    isOpen: false,
    currentMiniQuiz: null,
    currentQuestionIndex: 0,
    practiceScore: 0,
    awaitingResponse: false,
    conversationHistory: []
};

/* ====== ELEMENTS ====== */
const welcomeScreen = document.getElementById("welcome-screen");
const loadingScreen = document.getElementById("loading-screen");
const quizScreen = document.getElementById("quiz-screen");
const resultsScreen = document.getElementById("results-screen");
const qTextEl = document.getElementById("question-text");
const optsEl = document.getElementById("options-container");
const imgWrap = document.getElementById("question-image-container");
const imgEl = document.getElementById("question-image");
const currentQEl = document.getElementById("current-question");
const totalQEl = document.getElementById("total-questions");
const timeLeftEl = document.getElementById("time-left");
const timerIcon = document.getElementById("timer-icon");
const timerText = document.getElementById("timer-text");
const currentScoreEl = document.getElementById("current-score");
const progressBarEl = document.getElementById("progress-bar");
const finalScoreEl = document.getElementById("final-score");
const finalTotalEl = document.getElementById("final-total");
const percentageEl = document.getElementById("final-percentage");
const finalTimeEl = document.getElementById("final-time");
const resultsUserNameEl = document.getElementById("results-user-name");
const passFailBadge = document.getElementById("pass-fail-badge");
const passFailText = document.getElementById("pass-fail-text");
const passFailMessage = document.getElementById("pass-fail-message");
const resultIcon = document.getElementById("result-icon");
const analysisTotalTime = document.getElementById("analysis-total-time");
const analysisAvgTime = document.getElementById("analysis-avg-time");
const analysisEfficiency = document.getElementById("analysis-efficiency");
const aiWeaknessSummary = document.getElementById("ai-weakness-summary");
const categoryBreakdown = document.getElementById("category-breakdown");
const recommendationText = document.getElementById("recommendation-text");

/* ====== HELPERS ====== */
function safeJsonParse(val) {
  if (Array.isArray(val)) return val;
  if (val == null) return [];
  if (typeof val === "object") return Object.values(val);
  try {
    const parsed = JSON.parse(val);
    return Array.isArray(parsed) ? parsed : Object.values(parsed);
  } catch {
    return String(val).split(/\s*\|\s*|\s*,\s*/).filter(Boolean);
  }
}

function shuffle(array) {
  return array.map(a => [Math.random(), a]).sort((a, b) => a[0] - b[0]).map(a => a[1]);
}

function normalize(text) {
  return String(text || "")
    .replace(/^[A-D]\s*[\.\)]\s*/i, "")
    .trim()
    .toLowerCase();
}

function getCorrectText(row, opts) {
  if (row.answers && String(row.answers).trim()) return row.answers;
  const ca = row.correct_answer;
  if (!isNaN(ca)) {
    const n = Number(ca);
    if (n > 0 && n <= opts.length) return opts[n - 1];
    if (n >= 0 && n < opts.length) return opts[n];
  }
  return String(ca);
}

function buildImageUrl(u) {
  if (!u) return "";
  let s = String(u).trim();
  if (/^https?:\/\//i.test(s)) return s;
  return `${SUPABASE_URL}/storage/v1/object/public/signs/${s.replace(/^\//, "")}`;
}

function showImageIfAvailable(rawUrl) {
  const finalUrl = buildImageUrl(rawUrl);
  if (!finalUrl) {
    imgWrap.classList.add("hidden");
    imgEl.src = "";
    return;
  }
  const probe = new Image();
  probe.onload = () => {
    imgEl.src = finalUrl;
    imgWrap.classList.remove("hidden");
  };
  probe.onerror = () => {
    imgWrap.classList.add("hidden");
    imgEl.src = "";
  };
  probe.src = finalUrl;
}

function validateAge(dateOfBirth) {
  const today = new Date();
  const birthDate = new Date(dateOfBirth);
  const age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    return age - 1 >= 18;
  }
  return age >= 18;
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function updateProgress() {
  const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
  progressBarEl.style.width = `${progress}%`;
}

function createParticles() {
  const container = document.getElementById('particles-container');
  const particleCount = window.innerWidth < 768 ? 20 : 50;
  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.animationDelay = Math.random() * 8 + 's';
    particle.style.animationDuration = (Math.random() * 4 + 6) + 's';
    container.appendChild(particle);
  }
}

function calculateCategoryStats(performanceData) {
  const categoryStats = {};
  performanceData.forEach(item => {
    if (!categoryStats[item.category]) {
      categoryStats[item.category] = { correct: 0, total: 0, percentage: 0 };
    }
    categoryStats[item.category].total++;
    if (item.correct) categoryStats[item.category].correct++;
  });
  Object.keys(categoryStats).forEach(category => {
    const stats = categoryStats[category];
    stats.percentage = (stats.correct / stats.total) * 100;
  });
  return categoryStats;
}

function generateAIWeaknessAnalysis(score, total, performanceData) {
  const percentage = (score / total) * 100;
  const totalTime = performanceData.reduce((sum, item) => sum + item.timeSpent, 0);
  const avgTimePerQuestion = totalTime / total;
  const categoryStats = calculateCategoryStats(performanceData);

  const categoryNames = {
    'mandatory': 'Mandatory Signs',
    'cautionary': 'Cautionary Signs',
    'informational': 'Informational Signs',
    'rules': 'Traffic Rules',
    'cs': 'Construction Signs',
    'is': 'Information Signs',
    'general': 'General Knowledge'
  };

  const strengths = [];
  const weaknesses = [];
  const moderate = [];
  Object.entries(categoryStats).forEach(([category, stats]) => {
    const categoryName = categoryNames[category] || category;
    if (stats.percentage >= 80) {
      strengths.push(categoryName);
    } else if (stats.percentage < 50) {
      weaknesses.push(categoryName);
    } else {
      moderate.push(categoryName);
    }
  });

  let aiSummary = '';
  if (strengths.length > 0 && weaknesses.length > 0) {
    aiSummary = ` **AI Analysis**: You excel in ${strengths.join(' and ')}, but have growth opportunities in ${weaknesses.join(' and ')}. `;
  } else if (strengths.length > 0) {
    aiSummary = ` **Outstanding Performance**: You demonstrate exceptional knowledge across ${strengths.join(', ')}. `;
  } else if (weaknesses.length > 0) {
    aiSummary = ` **Learning Focus Areas**: Your primary development opportunities are in ${weaknesses.join(' and ')}. `;
  }

  if (percentage >= 90) {
    aiSummary += 'Your exceptional performance indicates mastery-level understanding of road safety principles.';
  } else if (percentage >= 80) {
    aiSummary += 'You have a solid foundation in road safety with room for minor enhancements.';
  } else if (percentage >= 70) {
    aiSummary += 'You understand core concepts but should strengthen knowledge in identified areas.';
  } else if (percentage >= 60) {
    aiSummary += 'Additional focused study is recommended to build confidence across all categories.';
  } else {
    aiSummary += 'Comprehensive review of all road safety categories is strongly recommended for success.';
  }

  if (avgTimePerQuestion <= 15) {
    aiSummary += '  Your efficient response times suggest strong familiarity with the material.';
  } else if (avgTimePerQuestion >= 25) {
    aiSummary += '  Taking additional time to consider answers demonstrates thoughtful decision-making.';
  }

  let recommendations = ' **Based on your AI-analyzed performance patterns:**\n\n';
  if (weaknesses.length > 0) {
    recommendations += ` **Priority Study Areas**: Focus intensive review on ${weaknesses.join(' and ')} to significantly improve your overall assessment score.\n\n`;
  }
  if (strengths.length > 0) {
    recommendations += ` **Maintain Excellence**: Continue reinforcing your strong knowledge in ${strengths.join(' and ')} through regular practice.\n\n`;
  }
  if (moderate.length > 0) {
    recommendations += ` **Enhancement Opportunities**: Build upon your moderate understanding of ${moderate.join(' and ')} with targeted study.\n\n`;
  }
  recommendations += ' **AI-Recommended Next Steps**: ';
  if (percentage < 75) {
    recommendations += 'Review official driving manuals, take additional practice assessments, and consider professional driver education courses for comprehensive preparation.';
  } else {
    recommendations += 'Continue practicing with varied question sets, stay updated with current traffic regulations, and consider advanced defensive driving courses.';
  }

  return {
    percentage,
    avgTime: avgTimePerQuestion,
    aiSummary,
    recommendations,
    timeEfficiency: avgTimePerQuestion <= 20 ? 'Excellent' : avgTimePerQuestion <= 25 ? 'Good' : 'Needs Improvement',
    strengths,
    weaknesses,
    moderate,
    categoryStats
  };
}

/* ====== VALIDATION ====== */
function validateUserInput() {
  const nameInput = document.getElementById('user-name');
  const dobInput = document.getElementById('user-dob');
  const nameError = document.getElementById('name-error');
  const dobError = document.getElementById('dob-error');
  let isValid = true;

  nameError.classList.add('hidden');
  dobError.classList.add('hidden');

  if (!nameInput.value.trim()) {
    nameError.classList.remove('hidden');
    nameInput.focus();
    isValid = false;
  } else {
    userData.name = nameInput.value.trim();
  }

  if (!dobInput.value) {
    dobError.textContent = 'Please enter your date of birth';
    dobError.classList.remove('hidden');
    if (isValid) dobInput.focus();
    isValid = false;
  } else if (!validateAge(dobInput.value)) {
    dobError.textContent = 'You must be at least 18 years old to take this quiz';
    dobError.classList.remove('hidden');
    if (isValid) dobInput.focus();
    isValid = false;
  } else {
    userData.dateOfBirth = dobInput.value;
  }

  return isValid;
}

/* ====== QUIZ FUNCTIONS ====== */
async function startQuiz() {
  if (!validateUserInput()) return;

  loadingScreen.classList.remove('hidden');
  welcomeScreen.classList.add('hidden');

  setTimeout(async () => {
    const { data, error } = await supabaseClient.from("quiz_questions").select("*");
    if (error) {
      console.error("Supabase error:", error.message);
      alert("Error loading questions. Check console for details.");
      loadingScreen.classList.add('hidden');
      welcomeScreen.classList.remove('hidden');
      return;
    }
    if (!data || data.length === 0) {
      alert("No questions found in database.");
      loadingScreen.classList.add('hidden');
      welcomeScreen.classList.remove('hidden');
      return;
    }

    questions = shuffle(
      data.map(row => {
        const opts = safeJsonParse(row.options) || [];
        return {
          id: row.id,
          question: row.question,
          options: shuffle([...opts]),
          correctText: getCorrectText(row, opts),
          image_url: row.image_url || "",
          category: row.category || "general",
          explanation: row.explanation || ""
        };
      })
    ).slice(0, 20);

    currentQuestionIndex = 0;
    score = 0;
    userPerformanceData = [];
    quizStartTime = Date.now();

    document.getElementById('quiz-user-name').textContent = userData.name;
    currentScoreEl.textContent = score;
    totalQEl.textContent = questions.length;

    loadingScreen.classList.add('hidden');
    quizScreen.classList.remove('hidden');
    showQuestion();
  }, 2000);
}

function showQuestion() {
  if (currentQuestionIndex >= questions.length) {
    showResults();
    return;
  }

  const question = questions[currentQuestionIndex];
  currentQEl.textContent = currentQuestionIndex + 1;
  qTextEl.textContent = question.question;
  updateProgress();

  showImageIfAvailable(question.image_url);

  optsEl.innerHTML = '';
  question.options.forEach((option, index) => {
    const button = document.createElement('button');
    button.className = `option-btn w-full p-6 rounded-2xl border-2 text-left transition-all duration-300 transform hover:scale-[1.02] disabled:transform-none bg-white border-gray-200 hover:border-blue-300 hover:bg-blue-50 hover:shadow-xl animate__animated animate__fadeInUp stagger-${index + 1}`;
    button.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="w-10 h-10 bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl flex items-center justify-center font-bold text-gray-600 text-lg">
            ${String.fromCharCode(65 + index)}
          </div>
          <span class="flex-1 text-lg">${option}</span>
        </div>
      </div>
    `;
    button.addEventListener('click', () => handleAnswer(option, button));
    optsEl.appendChild(button);
  });

  startTimer();
}

function startTimer() {
  clearInterval(timer);
  let timeLeft = 30;
  timeLeftEl.textContent = timeLeft;
  timerIcon.className = 'w-5 h-5 text-orange-600';
  timerText.className = 'font-medium text-gray-800 text-lg';
  const startTime = Date.now();

  timer = setInterval(() => {
    timeLeft--;
    timeLeftEl.textContent = timeLeft;
    if (timeLeft <= 10) {
      timerIcon.className = 'w-5 h-5 text-red-500 timer-warning';
      timerText.className = 'font-medium text-red-500 text-lg timer-warning';
    }
    if (timeLeft <= 0) {
      clearInterval(timer);
      handleTimeout();
    }
  }, 1000);
}

function handleTimeout() {
  const timeSpent = 30;
  userPerformanceData.push({
    id: questions[currentQuestionIndex].id,
    questionIndex: currentQuestionIndex,
    timeSpent: timeSpent,
    correct: false,
    selected: null,
    correctAnswer: questions[currentQuestionIndex].correctText,
    category: questions[currentQuestionIndex].category
  });

  const buttons = optsEl.querySelectorAll('button');
  buttons.forEach(button => {
    button.disabled = true;
    const optionText = button.querySelector('span').textContent;
    if (normalize(optionText) === normalize(questions[currentQuestionIndex].correctText)) {
      button.className = 'option-btn w-full p-6 rounded-2xl border-2 text-left bg-green-100 border-green-400 text-green-800 animate__animated animate__pulse';
      button.querySelector('.flex').innerHTML += `
        <div class="text-green-600 font-bold text-xl animate__animated animate__bounceIn"></div>
      `;
    } else {
      button.className = 'option-btn w-full p-6 rounded-2xl border-2 text-left bg-gray-100 border-gray-300 text-gray-600';
    }
  });

  setTimeout(nextQuestion, 2000);
}

function handleAnswer(selectedText, button) {
  clearInterval(timer);
  const timeSpent = 30 - parseInt(timeLeftEl.textContent);
  const isCorrect = normalize(selectedText) === normalize(questions[currentQuestionIndex].correctText);

  userPerformanceData.push({
    id: questions[currentQuestionIndex].id,
    questionIndex: currentQuestionIndex,
    timeSpent: timeSpent,
    correct: isCorrect,
    selected: selectedText,
    correctAnswer: questions[currentQuestionIndex].correctText,
    category: questions[currentQuestionIndex].category
  });

  if (isCorrect) {
    score++;
    currentScoreEl.textContent = score;
  }

  const buttons = optsEl.querySelectorAll('button');
  buttons.forEach(btn => {
    btn.disabled = true;
    const optionText = btn.querySelector('span').textContent;
    const isThisCorrect = normalize(optionText) === normalize(questions[currentQuestionIndex].correctText);
    const isThisSelected = btn === button;
    if (isThisCorrect) {
      btn.className = 'option-btn w-full p-6 rounded-2xl border-2 text-left bg-green-100 border-green-400 text-green-800 animate__animated animate__pulse';
      btn.querySelector('.flex').innerHTML += `
        <div class="text-green-600 font-bold text-xl animate__animated animate__bounceIn"></div>
      `;
    } else if (isThisSelected) {
      btn.className = 'option-btn w-full p-6 rounded-2xl border-2 text-left bg-red-100 border-red-400 text-red-800 animate__animated animate__shakeX';
      btn.querySelector('.flex').innerHTML += `
        <div class="text-red-600 font-bold text-xl animate__animated animate__bounceIn"></div>
      `;
    } else {
      btn.className = 'option-btn w-full p-6 rounded-2xl border-2 text-left bg-gray-100 border-gray-300 text-gray-600';
    }
  });

  setTimeout(nextQuestion, 2000);
}

function nextQuestion() {
  currentQuestionIndex++;
  showQuestion();
}

function showResults() {
  clearInterval(timer);
  const quizEndTime = Date.now();
  const totalTimeSeconds = Math.floor((quizEndTime - quizStartTime) / 1000);

  quizResults = {
    score: score,
    total: questions.length,
    attempts: userPerformanceData,
    weaknesses: [],
    userData: userData,
    totalTime: totalTimeSeconds
  };

  const categoryStats = calculateCategoryStats(userPerformanceData);
  Object.entries(categoryStats).forEach(([category, stats]) => {
    if (stats.percentage < 70) {
      quizResults.weaknesses.push(category);
    }
  });

  document.getElementById('chatbot-input').disabled = false;
  document.getElementById('chatbot-send').disabled = false;
  document.getElementById('chatbot-input').placeholder = "Ask me about your quiz results or road safety...";

  const chatbotMessages = document.getElementById('chatbot-messages');
  chatbotMessages.innerHTML = `
    <div class="message bot">
       Great job completing the quiz, ${userData.name}! You scored ${score}/${questions.length} (${((score/questions.length)*100).toFixed(1)}%).
      ${quizResults.weaknesses.length > 0 ? 
        `I noticed you had some challenges with ${quizResults.weaknesses.join(' and ')}. Want to practice those areas?` : 
        'Excellent performance across all categories! '
      }
    </div>
  `;

  quizScreen.classList.add('hidden');
  resultsScreen.classList.remove('hidden');

  resultsUserNameEl.textContent = userData.name;
  finalScoreEl.textContent = score;
  finalTotalEl.textContent = questions.length;
  const percentage = (score / questions.length) * 100;
  percentageEl.textContent = `${percentage.toFixed(1)}%`;
  finalTimeEl.textContent = formatTime(totalTimeSeconds);

  const passed = score >= 15;
  if (passed) {
    passFailBadge.className = 'inline-block px-12 py-6 rounded-full text-white font-bold text-4xl uppercase tracking-widest shadow-2xl pass-badge-enhanced animate__animated animate__tada animate__delay-2s';
    passFailText.innerHTML = `
      <span class="flex items-center">
        <svg class="w-10 h-10 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
        </svg>
        PASS
      </span>
    `;
    passFailMessage.innerHTML = ' <strong>Outstanding Achievement!</strong> You have successfully passed the AI-Powered Road Safety Assessment. Your comprehensive analysis shows strong understanding of road safety principles and you\'re well-prepared for safe driving!';
    resultIcon.className = 'w-28 h-28 bg-gradient-to-r from-emerald-400 via-teal-500 to-cyan-600 rounded-full mx-auto flex items-center justify-center animate__animated animate__bounceIn animate__delay-1s result-icon-enhanced shadow-2xl';
  } else {
    passFailBadge.className = 'inline-block px-12 py-6 rounded-full text-white font-bold text-4xl uppercase tracking-widest shadow-2xl fail-badge-enhanced animate__animated animate__tada animate__delay-2s';
    passFailText.innerHTML = `
      <span class="flex items-center">
        <svg class="w-10 h-10 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        NEEDS IMPROVEMENT
      </span>
    `;
    passFailMessage.innerHTML = ' The AI analysis indicates significant growth opportunities. You need at least 15 correct answers to pass. Use the detailed AI-powered feedback below to enhance your knowledge and <strong>retake the assessment</strong> when ready.';
    resultIcon.className = 'w-28 h-28 bg-gradient-to-r from-red-400 via-orange-500 to-pink-600 rounded-full mx-auto flex items-center justify-center animate__animated animate__bounceIn animate__delay-1s result-icon-enhanced shadow-2xl';
    resultIcon.innerHTML = `
      <svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
      </svg>
    `;
  }

  const analysis = generateAIWeaknessAnalysis(score, questions.length, userPerformanceData);
  analysisTotalTime.textContent = formatTime(totalTimeSeconds);
  analysisAvgTime.textContent = `${analysis.avgTime.toFixed(1)}s`;
  analysisEfficiency.textContent = analysis.timeEfficiency;
  aiWeaknessSummary.innerHTML = analysis.aiSummary.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  const categoryNames = {
    'mandatory': 'Mandatory Signs',
    'cautionary': 'Cautionary Signs',
    'informational': 'Informational Signs',
    'rules': 'Traffic Rules',
    'cs': 'Construction Signs',
    'is': 'Information Signs',
    'general': 'General Knowledge'
  };

  const categoryColors = {
    'mandatory': { emoji: '', iconClass: 'category-icon-mandatory', textColor: 'text-red-600' },
    'cautionary': { emoji: '', iconClass: 'category-icon-cautionary', textColor: 'text-yellow-600' },
    'informational': { emoji: '', iconClass: 'category-icon-informational', textColor: 'text-blue-600' },
    'rules': { emoji: '', iconClass: 'category-icon-rules', textColor: 'text-purple-600' },
    'cs': { emoji: '', iconClass: 'bg-orange-500', textColor: 'text-orange-600' },
    'is': { emoji: '', iconClass: 'bg-blue-500', textColor: 'text-blue-600' },
    'general': { emoji: '', iconClass: 'bg-gray-400', textColor: 'text-gray-600' }
  };

  let categoryHTML = '';
  Object.entries(analysis.categoryStats).forEach(([category, stats]) => {
    const displayName = categoryNames[category] || category;
    const strengthLevel = stats.percentage >= 80 ? 'high' : stats.percentage >= 50 ? 'medium' : 'low';
    const strengthColor = stats.percentage >= 80 ? 'text-emerald-600' : stats.percentage >= 50 ? 'text-yellow-600' : 'text-red-600';
    const categoryColor = categoryColors[category] || { emoji: '', iconClass: 'bg-gray-400', textColor: 'text-gray-600' };
    categoryHTML += `
      <div class="space-y-4 animate__animated animate__fadeInLeft animate__delay-3s">
        <div class="flex justify-between items-center">
          <span class="flex items-center text-lg">
            <div class="${categoryColor.iconClass} p-3 rounded-xl mr-4 text-white shadow-lg">
              <span class="text-lg">${categoryColor.emoji}</span>
            </div>
            <span class="font-medium">${displayName}</span>
          </span>
          <span class="font-bold ${strengthColor} text-xl bg-white/80 px-3 py-1 rounded-full">${stats.correct}/${stats.total} (${stats.percentage.toFixed(0)}%)</span>
        </div>
        <div class="strength-indicator">
          <div class="strength-fill ${strengthLevel}" style="width: ${stats.percentage}%"></div>
        </div>
      </div>
    `;
  });
  categoryBreakdown.innerHTML = categoryHTML;

  recommendationText.innerHTML = analysis.recommendations.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
}

function resetQuiz() {
  questions = [];
  currentQuestionIndex = 0;
  score = 0;
  userPerformanceData = [];
  userData = { name: '', dateOfBirth: '' };
  quizResults = null;

  chatbotState = {
    isOpen: false,
    currentMiniQuiz: null,
    currentQuestionIndex: 0,
    practiceScore: 0,
    awaitingResponse: false,
    conversationHistory: []
  };

  document.getElementById('chatbot-messages').innerHTML = `
    <div class="message bot">
       Hi! I'm your AI Study Assistant. Complete the quiz first to unlock all my features! I can help you understand your performance, explain wrong answers, and provide practice questions.
    </div>
  `;

  document.getElementById('chatbot-input').disabled = true;
  document.getElementById('chatbot-send').disabled = true;
  document.getElementById('chatbot-input').placeholder = "Complete the quiz first to unlock AI features...";
  document.getElementById('chatbot-input').value = '';

  document.getElementById('user-name').value = '';
  document.getElementById('user-dob').value = '';

  document.getElementById('name-error').classList.add('hidden');
  document.getElementById('dob-error').classList.add('hidden');

  loadingScreen.classList.add('hidden');
  quizScreen.classList.add('hidden');
  resultsScreen.classList.add('hidden');
  welcomeScreen.classList.remove('hidden');
  clearInterval(timer);
}

function shareResults() {
  const percentage = (score / questions.length) * 100;
  const status = score >= 15 ? 'PASSED' : 'NEEDS IMPROVEMENT';
  const text = ` ${userData.name} ${status} the AI-Powered Road Safety Quiz with ${score}/${questions.length} (${percentage.toFixed(1)}%)! `;

  if (navigator.share) {
    navigator.share({
      title: 'Road Safety Quiz Results - AI Analysis',
      text: text,
      url: window.location.href
    });
  } else {
    navigator.clipboard.writeText(`${text} Take the quiz: ${window.location.href}`).then(() => {
      const button = document.getElementById('share-btn');
      const originalText = button.innerHTML;
      button.innerHTML = `
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>Copied to Clipboard!</span>
      `;
      button.className = button.className.replace('share-btn-enhanced', 'bg-gradient-to-r from-green-500 to-emerald-600');
      setTimeout(() => {
        button.innerHTML = originalText;
        button.className = button.className.replace('bg-gradient-to-r from-green-500 to-emerald-600', 'share-btn-enhanced');
      }, 3000);
    });
  }
}

/* ====== CHATBOT FUNCTIONS ====== */
function toggleChatbot() {
  chatbotState.isOpen = !chatbotState.isOpen;
  const chatbotWindow = document.getElementById('chatbot-window');

  if (chatbotState.isOpen) {
    chatbotWindow.classList.add('open');
    document.getElementById('chatbot-input').focus();
    scrollChatToBottom();
  } else {
    chatbotWindow.classList.remove('open');
  }
}

function addChatbotMessage(text, sender = 'bot', isTyping = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender} ${isTyping ? 'typing' : ''}`;

  if (isTyping) {
    messageDiv.innerHTML = `
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <span style="margin-left: 10px;">AI is thinking...</span>
    `;
  } else {
    messageDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  }

  document.getElementById('chatbot-messages').appendChild(messageDiv);
  scrollChatToBottom();
  return messageDiv;
}

function scrollChatToBottom() {
  setTimeout(() => {
    const chatbotMessages = document.getElementById('chatbot-messages');
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
  }, 100);
}

function showTypingIndicator() {
  return addChatbotMessage('', 'bot', true);
}

function removeTypingIndicator(typingMsg) {
  if (typingMsg && typingMsg.parentNode) {
    typingMsg.parentNode.removeChild(typingMsg);
  }
}

async function handleChatbotMessage(message) {
  const lowerMessage = message.toLowerCase().trim();

  if (!quizResults) {
    addChatbotMessage("Please complete the quiz first to unlock all my AI features! I'll be much more helpful after you finish the assessment. ", 'bot');
    return;
  }

  const typingMsg = showTypingIndicator();

  await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1500));

  removeTypingIndicator(typingMsg);

  if (lowerMessage.includes('performance') || lowerMessage.includes('score') || lowerMessage.includes('result') || lowerMessage.includes('analysis')) {
    explainPerformance();
  } else if (lowerMessage.includes('practice') || lowerMessage.includes('weak') || lowerMessage.includes('improve')) {
    startPracticeSession();
  } else if (lowerMessage.includes('wrong') || lowerMessage.includes('explanation') || lowerMessage.includes('explain')) {
    explainWrongAnswers();
  } else if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
    let response = ` **I'm your AI Study Assistant!** Here's what I can help you with:\n\n`;
    response += ` **Performance Analysis** - Detailed breakdown of your quiz results\n`;
    response += ` **Answer Explanations** - Understand why you got questions wrong\n`;
    response += ` **Practice Sessions** - Mini-quizzes for your weak areas\n`;
    response += ` **Road Safety Tips** - General advice and clarification\n\n`;
    response += `Just ask me things like:\n`;
    response += ` "Explain my performance"\n`;
    response += ` "Why was question 5 wrong?"\n`;
    response += ` "Practice weak areas"\n`;
    response += ` "Help me with speed limits"`;
    addChatbotMessage(response, 'bot');
  } else if (lowerMessage.includes('speed limit') || lowerMessage.includes('speed')) {
    addChatbotMessage(` **Speed Limits in Road Safety:**\n\n **Urban areas**: Typically 50 km/h unless otherwise posted\n **School zones**: Usually 25-40 km/h during school hours\n **Highways**: Varies by country (100-130 km/h)\n **Construction zones**: Reduced speeds for safety\n\n Always follow posted signs and adjust for conditions!`, 'bot');
  } else if (lowerMessage.includes('signs') || lowerMessage.includes('traffic sign')) {
    addChatbotMessage(` **Traffic Signs Categories:**\n\n **Mandatory Signs**: Stop, yield, speed limits\n **Warning Signs**: Curves, intersections, hazards\n **Information Signs**: Directions, services, distances\n **Construction Signs**: Work zones, detours\n\nEach category has specific shapes and colors for quick recognition.`, 'bot');
  } else if (lowerMessage.includes('thank') || lowerMessage.includes('bye') || lowerMessage.includes('goodbye')) {
    addChatbotMessage(` You're welcome, ${quizResults.userData.name}! Keep practicing road safety - it saves lives! Drive safe! `, 'bot');
  } else {
    addChatbotMessage(` I'm not sure about that specific question, but I'm here to help with your road safety learning! Try asking me about:\n\n Your quiz performance\n Explanations for wrong answers\n Practice questions for weak areas\n General road safety topics\n\nWhat would you like to know?`, 'bot');
  }
}

function explainPerformance() {
  if (!quizResults) {
    addChatbotMessage("Please complete the quiz first to see your performance analysis! ", 'bot');
    return;
  }

  const { score, total, weaknesses } = quizResults;
  const percentage = (score / total) * 100;
  const categoryStats = calculateCategoryStats(quizResults.attempts);

  let message = ` **Performance Summary for ${quizResults.userData.name}:**\n\n`;
  message += ` **Overall Score:** ${score}/${total} (${percentage.toFixed(1)}%)\n`;
  message += ` **Total Time:** ${formatTime(quizResults.totalTime)}\n\n`;

  if (percentage >= 75) {
    message += ` **Excellent performance!** You demonstrate strong road safety knowledge.\n\n`;
  } else if (percentage >= 60) {
    message += ` **Good foundation** but there's room for improvement in some areas.\n\n`;
  } else {
    message += ` **More study needed.** Focus on the weak areas identified below.\n\n`;
  }

  message += `**Category Breakdown:**\n`;
  Object.entries(categoryStats).forEach(([category, stats]) => {
    const emoji = stats.percentage >= 80 ? '' : stats.percentage >= 60 ? '' : '';
    const categoryName = {
      'mandatory': 'Mandatory Signs',
      'cautionary': 'Cautionary Signs',
      'informational': 'Informational Signs',
      'rules': 'Traffic Rules',
      'cs': 'Construction Signs',
      'is': 'Information Signs',
      'general': 'General Knowledge'
    }[category] || category;
    message += `${emoji} **${categoryName}:** ${stats.correct}/${stats.total} (${stats.percentage.toFixed(0)}%)\n`;
  });

  if (weaknesses.length > 0) {
    message += `\n **Focus Areas:** ${weaknesses.map(w => w.replace('_', ' ')).join(', ')}\n`;
    message += `\nWould you like to practice these weak areas? `;
  }

  addChatbotMessage(message, 'bot');
}

function explainWrongAnswers() {
  if (!quizResults) {
    addChatbotMessage("Please complete the quiz first to see explanations! ", 'bot');
    return;
  }

  const wrongAnswers = quizResults.attempts.filter(attempt => !attempt.correct);

  if (wrongAnswers.length === 0) {
    addChatbotMessage(" Amazing! You got all questions correct! No explanations needed.", 'bot');
    return;
  }

  addChatbotMessage(` You got ${wrongAnswers.length} questions wrong. Let me explain each one:`, 'bot');

  setTimeout(() => {
    for (let i = 0; i < Math.min(wrongAnswers.length, 3); i++) {
      const attempt = wrongAnswers[i];
      const question = questions.find(q => q.id === attempt.id);

      let explanation = `\n**Question ${attempt.questionIndex + 1}:** ${question ? question.question : 'Question text'}\n\n`;
      explanation += ` **Your Answer:** ${attempt.selected || 'No answer (timeout)'}\n`;
      explanation += ` **Correct Answer:** ${attempt.correctAnswer}\n\n`;

      if (question && question.explanation && question.explanation.trim()) {
        explanation += ` **Explanation:** ${question.explanation}\n\n`;
      } else {
        explanation += ` **Why:** The correct answer is "${attempt.correctAnswer}" because this is the standard road safety rule according to traffic regulations.\n\n`;
      }

      setTimeout(() => {
        addChatbotMessage(explanation, 'bot');
      }, i * 1500);
    }

    if (wrongAnswers.length > 3) {
      setTimeout(() => {
        addChatbotMessage(`... and ${wrongAnswers.length - 3} more. Would you like to practice these areas? `, 'bot');
      }, 3 * 1500);
    }
  }, 1000);
}

function startPracticeSession() {
  if (!quizResults || quizResults.weaknesses.length === 0) {
    addChatbotMessage("You performed well across all categories!  No specific weak areas to practice.", 'bot');
    return;
  }

  addChatbotMessage(" Let's practice your weak areas! I'll create some sample questions for you...", 'bot');

  setTimeout(() => {
    addChatbotMessage(" **Practice Question 1:** What does a red traffic light mean?\n\nA) Proceed with caution\nB) Stop completely\nC) Slow down\nD) Yield to traffic\n\nType your answer (A, B, C, or D)", 'bot');
  }, 2000);
}

/* ====== INITIALIZATION ====== */
document.addEventListener('DOMContentLoaded', function() {
  createParticles();
  document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);
  document.getElementById('home-btn').addEventListener('click', function() {
    window.location.href = 'index.html';
  });
  document.getElementById('retake-btn').addEventListener('click', resetQuiz);
  document.getElementById('share-btn').addEventListener('click', shareResults);
  document.getElementById('chatbot-toggle').addEventListener('click', toggleChatbot);
  document.getElementById('chatbot-send').addEventListener('click', function() {
    const message = document.getElementById('chatbot-input').value.trim();
    if (message && !chatbotState.awaitingResponse) {
      addChatbotMessage(message, 'user');
      document.getElementById('chatbot-input').value = '';
      chatbotState.awaitingResponse = true;
      setTimeout(() => {
        handleChatbotMessage(message);
        chatbotState.awaitingResponse = false;
      }, 500);
    }
  });

  document.getElementById('chatbot-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('chatbot-send').click();
    }
  });

  document.querySelectorAll('input').forEach(input => {
    input.addEventListener('focus', function() {
      this.parentElement.classList.add('animate__animated', 'animate__pulse');
      const errorEl = this.parentElement.querySelector('.error-message');
      if (errorEl) errorEl.classList.add('hidden');
    });
    input.addEventListener('blur', function() {
      this.parentElement.classList.remove('animate__animated', 'animate__pulse');
    });
  });

  document.addEventListener('keydown', function(e) {
    if (quizScreen.classList.contains('hidden')) return;
    const optionButtons = optsEl.querySelectorAll('button:not(:disabled)');
    if (e.key >= '1' && e.key <= '4') {
      const index = parseInt(e.key) - 1;
      if (optionButtons[index]) {
        optionButtons[index].click();
      }
    } else if (e.key.toLowerCase() >= 'a' && e.key.toLowerCase() <= 'd') {
      const index = e.key.toLowerCase().charCodeAt(0) - 97;
      if (optionButtons[index]) {
        optionButtons[index].click();
      }
    }
  });
});
</script>
</html>